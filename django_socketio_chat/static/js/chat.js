// Generated by CoffeeScript 1.4.0
var Chat,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

Chat = (function() {
  var chat_session, conn;

  function Chat() {
    this.list_users = __bind(this.list_users, this);

    this.update_chats_chat_messages_message_ui = __bind(this.update_chats_chat_messages_message_ui, this);

    this.update_chats_chat_messages_ui = __bind(this.update_chats_chat_messages_ui, this);

    this.ui_chat_archive = __bind(this.ui_chat_archive, this);

    this.ui_chat_clear_unread_messages = __bind(this.ui_chat_clear_unread_messages, this);

    this.ui_chat_set_unread_messages = __bind(this.ui_chat_set_unread_messages, this);

    this.ui_chat_deactivate = __bind(this.ui_chat_deactivate, this);

    this.ui_chat_activate = __bind(this.ui_chat_activate, this);

    this.get_user_chat_status = __bind(this.get_user_chat_status, this);

    this.update_chats_chat_ui = __bind(this.update_chats_chat_ui, this);

    this.update_chats_ui = __bind(this.update_chats_ui, this);

    this.ui_add_user = __bind(this.ui_add_user, this);

    this.update_users_ui = __bind(this.update_users_ui, this);

    this.ui_signed_in = __bind(this.ui_signed_in, this);

  }

  chat_session = null;

  conn = null;

  Chat.prototype.init = function() {
    return this.connect();
  };

  Chat.prototype.debug_log = function(msg) {
    var control, now;
    control = $('#debug-log');
    now = new Date();
    return control.append(now.toLocaleTimeString() + ': ' + msg + '<br/>');
  };

  Chat.prototype.connect = function() {
    var _this = this;
    this.conn = io.connect('https://' + window.location.host, {
      'force_new_connection': false,
      'rememberTransport': true,
      'resource': 'chat/socket.io'
    });
    this.debug_log('Connecting...');
    this.conn.on('connect', function() {
      return _this.debug_log('Connected');
    });
    this.conn.on('ev_chat_session_status', function(chat_session) {
      _this.chat_session = chat_session;
      if (_this.chat_session.status === 0) {
        return _this.ui_signed_off();
      }
    });
    this.conn.on('ev_data_update', function(chat_session, chat_users, chats) {
      _this.chat_session = chat_session;
      _this.ui_signed_in();
      _this.chat_users = chat_users;
      _this.update_users_ui(chat_users);
      return _this.update_chats_ui(chats);
    });
    this.conn.on('disconnect', function(data) {
      _this.debug_log('Disconnect');
      return _this.conn = null;
    });
    this.conn.on('ev_user_signed_in', function(username, chat_users) {
      _this.debug_log(username + ' signed in.');
      _this.chat_users = chat_users;
      return _this.update_users_ui(chat_users);
    });
    this.conn.on('ev_user_signed_off', function(username, chat_users) {
      _this.debug_log(username + ' signed off.');
      _this.chat_users = chat_users;
      return _this.update_users_ui(chat_users);
    });
    this.conn.on('ev_chat_created', function(chat) {
      return _this.update_chats_chat_ui(chat);
    });
    this.conn.on('ev_you_were_added', function(chat) {
      return _this.update_chats_chat_ui(chat);
    });
    this.conn.on('ev_message_sent', function(message, user_chat_statuses) {
      var user_chat_status;
      _this.update_chats_chat_messages_message_ui(message);
      user_chat_status = _this.get_user_chat_status(user_chat_statuses);
      return _this.ui_chat_set_unread_messages(message.chat__uuid, user_chat_status.unread_messages);
    });
    this.conn.on('ev_chat_activated', function(chat_uuid) {
      return _this.ui_chat_activate(chat_uuid);
    });
    this.conn.on('ev_chat_deactivated', function(chat_uuid) {
      return _this.ui_chat_deactivate(chat_uuid);
    });
    return this.conn.on('ev_chat_archived', function(chat_uuid) {
      return _this.ui_chat_archive(chat_uuid);
    });
  };

  Chat.prototype.ui_signed_off = function() {
    var _this = this;
    $('#chat-window').hide();
    $('#chat-session-state').html('<h1>Signed off</h1><a id="sign-in" href="#">Sign in</a>');
    return $('#sign-in').click(function(e) {
      e.preventDefault();
      return _this.conn.emit('req_user_sign_in');
    });
  };

  Chat.prototype.ui_signed_in = function() {
    var $chat_window,
      _this = this;
    $chat_window = $('#chat-window');
    $chat_window.show();
    $('#chat-session-state').html('<h1>Signed in</h1><a id="sign-off" href="#">Sign off</a>');
    return $('#sign-off').click(function(e) {
      e.preventDefault();
      return _this.conn.emit('req_user_sign_off');
    });
  };

  Chat.prototype.update_users_ui = function(users) {
    var user, _i, _len, _results;
    $('#user-list').empty();
    _results = [];
    for (_i = 0, _len = users.length; _i < _len; _i++) {
      user = users[_i];
      _results.push(this.ui_add_user(user));
    }
    return _results;
  };

  Chat.prototype.ui_add_user = function(user) {
    var $user_el, $user_list, _ref,
      _this = this;
    $user_list = $('#user-list');
    $user_el = $('<li><a href="#">' + user.username + ' (' + ((_ref = user.is_online) != null ? _ref : {
      'online': 'offline'
    }) + ')</a></li>');
    $user_list.append($user_el);
    return $user_el.on('click', function(e) {
      e.preventDefault();
      return _this.conn.emit('req_chat_create', user.username);
    });
  };

  Chat.prototype.update_chats_ui = function(chats) {
    var chat, _i, _len, _results;
    $('#chat-list').empty();
    _results = [];
    for (_i = 0, _len = chats.length; _i < _len; _i++) {
      chat = chats[_i];
      _results.push(this.update_chats_chat_ui(chat));
    }
    return _results;
  };

  Chat.prototype.update_chats_chat_ui = function(chat) {
    var $chat_active_toggle, $chat_el, $chat_list, $message_input_el, $message_input_textarea, $messages_el, chat_usernames, self, ucs, user_chat_status,
      _this = this;
    $chat_list = $('#chat-list');
    chat_usernames = ((function() {
      var _i, _len, _ref, _results;
      _ref = chat.user_chat_statuses;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        ucs = _ref[_i];
        _results.push(ucs.user__username);
      }
      return _results;
    })()).join(', ');
    $chat_el = $('<div id="chat-' + chat.uuid + '"> <h4>' + chat_usernames + ' <a href="#" class="toggle-active"></a> <a href="#" class="archive">Archive</a> <a href="#" class="list-users">+</a> <span class="unread-messages"></span></h4> <ul class="chat-user-list"></ul> </div>');
    $messages_el = $('<div class="messages"></div>');
    $message_input_el = $('<div class="message-input"> <textarea placeholder="Type message"></textarea> </div>');
    $chat_el.append($messages_el);
    $chat_el.append($message_input_el);
    $message_input_textarea = $message_input_el.find('textarea');
    self = this;
    $message_input_textarea.keypress(function(e) {
      if (e.which === 13) {
        e.preventDefault();
        self.conn.emit('req_message_send', this.value, chat.uuid);
        return this.value = '';
      }
    });
    $chat_active_toggle = $chat_el.find('.toggle-active');
    user_chat_status = this.get_user_chat_status(chat.user_chat_statuses);
    $chat_active_toggle.click(function(e) {
      e.preventDefault();
      if ($chat_active_toggle.hasClass('js_active')) {
        return _this.conn.emit('req_chat_deactivate', chat.uuid);
      } else {
        return _this.conn.emit('req_chat_activate', chat.uuid);
      }
    });
    $chat_el.find('.list-users').click(function(e) {
      e.preventDefault();
      return _this.list_users(chat.uuid);
    });
    $chat_el.find('.archive').click(function(e) {
      e.preventDefault();
      return _this.conn.emit('req_chat_archive', chat.uuid);
    });
    $chat_list.append($chat_el);
    if (user_chat_status.status === 'active') {
      this.ui_chat_activate(chat.uuid);
    } else if (user_chat_status.status === 'inactive') {
      this.ui_chat_deactivate(chat.uuid);
      this.ui_chat_set_unread_messages(chat.uuid, user_chat_status.unread_messages);
    }
    if (chat.messages.length > 0) {
      return this.update_chats_chat_messages_ui(chat.messages);
    }
  };

  Chat.prototype.get_user_chat_status = function(user_chat_statuses) {
    var self, ucs;
    self = this;
    return ((function() {
      var _i, _len, _results;
      _results = [];
      for (_i = 0, _len = user_chat_statuses.length; _i < _len; _i++) {
        ucs = user_chat_statuses[_i];
        if (ucs.user__username === self.chat_session.username) {
          _results.push(ucs);
        }
      }
      return _results;
    })())[0];
  };

  Chat.prototype.ui_chat_activate = function(chat_uuid) {
    var chat, toggle;
    chat = $("#chat-" + chat_uuid);
    toggle = chat.find(".toggle-active");
    toggle.text('Deactivate');
    toggle.addClass('js_active');
    chat.find('.messages').show();
    chat.find('.message-input').show();
    return this.ui_chat_clear_unread_messages(chat_uuid);
  };

  Chat.prototype.ui_chat_deactivate = function(chat_uuid) {
    var chat, toggle;
    chat = $("#chat-" + chat_uuid);
    toggle = chat.find(".toggle-active");
    toggle.text(' Activate');
    toggle.removeClass('js_active');
    chat.find('.messages').hide();
    return chat.find('.message-input').hide();
  };

  Chat.prototype.ui_chat_set_unread_messages = function(chat_uuid, count) {
    var chat;
    chat = $("#chat-" + chat_uuid);
    if (count > 0) {
      return chat.find('.unread-messages').html(count);
    }
  };

  Chat.prototype.ui_chat_clear_unread_messages = function(chat_uuid) {
    var chat;
    chat = $("#chat-" + chat_uuid);
    return chat.find('.unread-messages').html('');
  };

  Chat.prototype.ui_chat_archive = function(chat_uuid) {
    var chat;
    chat = $("#chat-" + chat_uuid);
    return chat.remove();
  };

  Chat.prototype.update_chats_chat_messages_ui = function(messages) {
    var message, _i, _len, _results;
    _results = [];
    for (_i = 0, _len = messages.length; _i < _len; _i++) {
      message = messages[_i];
      _results.push(this.update_chats_chat_messages_message_ui(message));
    }
    return _results;
  };

  Chat.prototype.update_chats_chat_messages_message_ui = function(message) {
    var $chat_messages_el, s, stamp,
      _this = this;
    $chat_messages_el = $('#chat-list #chat-' + message.chat__uuid + ' .messages');
    stamp = function(timestamp) {
      return new Date(timestamp).toLocaleTimeString().slice(0, -3);
    };
    s = '<div id="message-' + message.uuid + '">' + stamp(message.timestamp) + message.user_from__username + ': ' + message.message_body + '</div>';
    return $chat_messages_el.append($(s));
  };

  Chat.prototype.list_users = function(chat_uuid) {
    var $chat_user_list, chat, user, _i, _len, _ref,
      _this = this;
    chat = $("#chat-" + chat_uuid);
    $chat_user_list = chat.find('.chat-user-list');
    $chat_user_list.empty();
    _ref = this.chat_users;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      user = _ref[_i];
      $chat_user_list.append('<li><a href="#" class="user-add" data-username="' + user.username + '">' + user.username + '</a></li>');
    }
    return $chat_user_list.on('click', '.user-add', function(e) {
      e.preventDefault();
      return _this.conn.emit('req_chat_add_user', chat_uuid, $(e.target).data('username'));
    });
  };

  return Chat;

})();

$(function() {
  var chat;
  chat = new Chat();
  return chat.init();
});
